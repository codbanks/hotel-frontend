"use strict";(self.webpackChunkhotel_frontend=self.webpackChunkhotel_frontend||[]).push([[777],{777:(t,e,a)=>{a.r(e),a.d(e,{default:()=>v});var s=a(555),n=a(43),l=a(931);const r=["balBf","acc","food","bar","laundry","swimming","roomHire","other","tCharge","usdSwipe","ecoCash","zigSwipe","cash","tLedger","bankTr","balCf"],i=["folio","guestName","pax",...r];function o(){const t={id:null,row:(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)+1,_saveStatus:"new"};return i.forEach(e=>{t[e]=r.includes(e)?0:""}),t}function c(t){const e=parseFloat(t);return isNaN(e)?0:e}function d(t){return(null!==t&&void 0!==t?t:0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}function u(t){let e=new Date(t);"string"!==typeof t||t.includes("T")||(e=new Date(t+"T00:00:00"));const a=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return"".concat(a,"-").concat(s,"-").concat(n)}function h(t){const e=new Date(t+"T00:00:00");return e.setDate(e.getDate()+1),u(e)}function g(t){const e=new Date(t+"T00:00:00");return e.setDate(e.getDate()-1),u(e)}var x=a(579);function f(t){let{derivedRows:e=[],cashAccounts:a={},currentDate:s,setCellValue:n,setCashValue:l,cashTotals:r={},totals:i={},debtorsInRes:o=0,inputRefs:c,onSaveRow:u}=t;const h=["balBf","acc","food","bar","laundry","swimming","roomHire","other","tCharge","usdSwipe","ecoCash","zigSwipe","cash","tLedger","bankTr"],g=t=>{let{title:e}=t;return(0,x.jsx)("th",{children:(0,x.jsx)("span",{dangerouslySetInnerHTML:{__html:e}})})},f=a[s]||Object.fromEntries(h.map(t=>[t,0]));return(0,x.jsxs)("div",{className:"ledger-table-wrap",children:[(0,x.jsxs)("table",{className:"ledger-table",children:[(0,x.jsxs)("colgroup",{children:[(0,x.jsx)("col",{style:{width:"2%"}}),"  ",(0,x.jsx)("col",{style:{width:"5%"}}),"  ",(0,x.jsx)("col",{style:{width:"13%"}})," ",(0,x.jsx)("col",{style:{width:"4%"}}),"  ",(0,x.jsx)("col",{style:{width:"5%"}}),"  ",(0,x.jsx)("col",{style:{width:"4%"}})," ",(0,x.jsx)("col",{style:{width:"4%"}})," ",(0,x.jsx)("col",{style:{width:"4%"}})," ",(0,x.jsx)("col",{style:{width:"4%"}})," ",(0,x.jsx)("col",{style:{width:"4%"}})," ",(0,x.jsx)("col",{style:{width:"4%"}})," ",(0,x.jsx)("col",{style:{width:"4%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"5%"}})," ",(0,x.jsx)("col",{style:{width:"3%"}})," "]}),(0,x.jsx)("thead",{children:(0,x.jsxs)("tr",{children:[(0,x.jsx)("th",{children:"#"}),(0,x.jsx)("th",{children:"Folio"}),(0,x.jsx)("th",{children:"Guest Name"}),(0,x.jsx)("th",{children:"Pax"}),(0,x.jsx)(g,{title:"Bal<br/>B/F"}),(0,x.jsx)(g,{title:"Acc"}),(0,x.jsx)(g,{title:"Food"}),(0,x.jsx)(g,{title:"Bar"}),(0,x.jsx)(g,{title:"Lndry"}),(0,x.jsx)(g,{title:"Pool"}),(0,x.jsx)(g,{title:"Room"}),(0,x.jsx)(g,{title:"Other"}),(0,x.jsx)(g,{title:"Total<br/>Chrg"}),(0,x.jsx)(g,{title:"USD<br/>Swp"}),(0,x.jsx)(g,{title:"Eco"}),(0,x.jsx)(g,{title:"ZIG"}),(0,x.jsx)(g,{title:"Cash"}),(0,x.jsx)(g,{title:"Ledg"}),(0,x.jsx)(g,{title:"Bank"}),(0,x.jsx)(g,{title:"Bal<br/>C/F"}),(0,x.jsx)("th",{children:"\ud83d\udcbe"})]})}),(0,x.jsxs)("tbody",{children:[e.map((t,e)=>(0,x.jsxs)("tr",{children:[(0,x.jsx)("td",{style:{textAlign:"center",color:"#666"},children:t.row}),(0,x.jsx)("td",{children:(0,x.jsx)("input",{type:"text",value:t.folio||"",onChange:t=>n(e,"folio",t.target.value)})}),(0,x.jsx)("td",{children:(0,x.jsx)("input",{type:"text",ref:t=>c.current["".concat(e,"-guestName")]=t,value:t.guestName||"",onChange:t=>n(e,"guestName",t.target.value)})}),(0,x.jsx)("td",{children:(0,x.jsx)("input",{type:"number",style:{textAlign:"center"},value:t.pax||"",onChange:t=>n(e,"pax",t.target.value)})}),h.map(a=>(0,x.jsx)("td",{children:(0,x.jsx)("input",{type:"number",step:"0.01",placeholder:"-",value:0===t[a]?"":t[a],onChange:t=>n(e,a,t.target.value)})},a)),(0,x.jsx)("td",{style:{textAlign:"right",paddingRight:"4px",fontWeight:"bold",color:t.balCf<0?"red":"inherit"},children:d(t.balCf)}),(0,x.jsx)("td",{children:(0,x.jsx)("button",{className:"save-row-btn ".concat("saved"===t._saveStatus?"saved":""),onClick:()=>u(e),title:"Save Row",children:"saved"===t._saveStatus?"\u2705":"\ud83d\udcbe"})})]},e)),(0,x.jsxs)("tr",{className:"cash-row",children:[(0,x.jsx)("td",{colSpan:4,style:{textAlign:"right",paddingRight:"10px"},children:"CASH ACC"}),h.map(t=>(0,x.jsx)("td",{children:(0,x.jsx)("input",{type:"number",step:"0.01",value:0===f[t]?"":f[t],onChange:e=>l(t,e.target.value)})},t)),(0,x.jsx)("td",{style:{textAlign:"right",paddingRight:"4px"},children:d(r.balCf)}),(0,x.jsx)("td",{})]}),(0,x.jsxs)("tr",{className:"totals-row",children:[(0,x.jsx)("td",{colSpan:4,style:{textAlign:"right",paddingRight:"10px"},children:"TOTALS"}),h.map(t=>(0,x.jsx)("td",{style:{textAlign:"right",paddingRight:"4px"},children:d(i[t])},t)),(0,x.jsx)("td",{style:{textAlign:"right",paddingRight:"4px"},children:d(i.balCf)}),(0,x.jsx)("td",{})]}),(0,x.jsx)("tr",{className:"debtors-row",children:(0,x.jsxs)("td",{colSpan:21,children:["Debtors in Residence: ",(0,x.jsx)("span",{style:{color:"var(--pumpkin)",fontWeight:"bold"},children:d(o)})]})})]})]}),(0,x.jsx)("div",{style:{height:"80px"}})," "]})}async function w(t,e,a,s,n){try{const l=await t.get("/ledger_stats/?date=".concat(e)),r=Array.isArray(l.data)&&l.data.length?l.data[0]:null,i={date:e,debtors_in_res:n};if(Object.keys(a).forEach(t=>{var e;(t.startsWith("cash_")||"tCharge"===t||"balCf"===t)&&(i[t]=null!==(e=a[t])&&void 0!==e?e:0)}),Object.keys(s).forEach(t=>{var e;(t.startsWith("total_")||"tCharge"===t||"balCf"===t)&&(i[t]=null!==(e=s[t])&&void 0!==e?e:0)}),r){Object.keys(i).some(t=>Number(r[t])!==Number(i[t]))&&(await t.put("/ledger_stats/".concat(r.id,"/"),i),console.log("Ledger stats updated for date:",e))}else await t.post("/ledger_stats/",i),console.log("Ledger stats created for date:",e)}catch(l){console.error("LedgerStatsUpdater error:",l)}}var j=a(216);function b(t){let{dates:e,visibleDates:a,visibleStartIndex:s,currentDateIndex:n,prevDate:l,nextDate:r,selectDate:i,addNewDateAuto:o,addNewDateAutoBackward:c,resetViewToLatestDate:d,handleManualDateChange:u,addRow:h,saveAll:g,savingAll:f}=t;return(0,x.jsxs)("div",{className:"ledger-bottom-bar",children:[(0,x.jsxs)("div",{className:"date-nav-bar",children:[(0,x.jsx)("button",{onClick:l,disabled:n<=0,children:"\u25c0"}),(0,x.jsxs)("div",{className:"date-tabs",children:[(0,x.jsx)("button",{className:"date-tab minus",onClick:c,title:"Add previous day",children:"\u2796"}),a.map((t,e)=>{const a=s+e;const l=a===n;return(0,x.jsx)("button",{className:"date-tab ".concat(l?"active":""),onClick:()=>i(a),children:t},t)}),(0,x.jsx)("button",{className:"date-tab plus",onClick:o,title:"Add next day",children:"\uff0b"})]}),(0,x.jsx)("button",{onClick:r,disabled:n>=e.length-1,children:"\u25b6"}),(0,x.jsx)("div",{className:"manual-date-filter",children:(0,x.jsx)("input",{type:"date",onChange:u})})]}),(0,x.jsxs)("div",{className:"actions",children:[(0,x.jsx)("button",{className:"btn primary",onClick:d,title:"Go back to the latest recorded date and clear extra tabs",children:"\ud83d\udcc5 Reset View"}),(0,x.jsx)("button",{className:"btn",onClick:h,children:"\u2795 Add row"}),(0,x.jsx)("button",{className:"btn outline",onClick:g,disabled:f,children:f?"Saving...":"Save All"}),(0,x.jsx)("button",{className:"btn outline",onClick:()=>window.print(),children:"Print"})]})]})}function v(){var t;(0,j.Zp)();const[e,a]=(0,n.useState)([]),[d,v]=(0,n.useState)(-1),[p,m]=(0,n.useState)({}),[y,A]=(0,n.useState)({}),[C,S]=(0,n.useState)(!1),[N,D]=(0,n.useState)(!1),[k,R]=(0,n.useState)(!1),E=(0,n.useRef)({}),T=["acc","food","bar","laundry","swimming","roomHire","other"];async function _(t){try{const e=await l.A.get("/ledger/?date=".concat(t));return Array.isArray(e.data)&&0!==e.data.length?e.data.map((t,e)=>{var a;const s=o(e);return i.forEach(e=>{s[e]=void 0!==t[e]&&null!==t[e]?t[e]:r.includes(e)?0:s[e]}),s.id=null!==(a=t.id)&&void 0!==a?a:null,s._saveStatus="saved",s.row=e+1,s}):[o(0)]}catch(e){return console.error("fetchRowsFromApi error:",e),[o(0)]}}async function L(t,e){if(p[e]&&p[e].length)return p[e];let a=[];if(t){let e=[];p[t]&&p[t].length?e=p[t]:(e=await _(t),m(a=>(0,s.A)((0,s.A)({},a),{},{[t]:e}))),e.forEach(t=>{const{tCharge:e,balCf:n}=function(t){var e;const a=T.reduce((e,a)=>e+c(t[a]),0);return{tCharge:a,balCf:c(null!==(e=t.tCharge)&&void 0!==e?e:a)+c(t.balBf)-c(t.bankTr)-c(t.tLedger)-c(t.cash)-c(t.zigSwipe)-c(t.ecoCash)-c(t.usdSwipe)}}(t);if(t.guestName&&""!==String(t.guestName).trim()&&0!==Number(n)){var l,r;const e=(0,s.A)((0,s.A)({},o(a.length)),{},{guestName:t.guestName,folio:null!==(l=t.folio)&&void 0!==l?l:"",pax:null!==(r=t.pax)&&void 0!==r?r:0,balBf:Number(n),acc:0,food:0,bar:0,laundry:0,swimming:0,roomHire:0,other:0,tCharge:0,usdSwipe:0,ecoCash:0,zigSwipe:0,cash:0,tLedger:0,bankTr:0,balCf:0,id:null,_saveStatus:"new",row:a.length+1});a.push(e)}})}const n=a.length?a:[o(0)];return m(t=>(0,s.A)((0,s.A)({},t),{},{[e]:n})),A(t=>(0,s.A)((0,s.A)({},t),{},{[e]:Object.fromEntries(r.map(t=>[t,0]))})),n}(0,n.useEffect)(()=>{!async function(){S(!0);try{const t=await l.A.get("/ledger_dates/"),e=Array.isArray(t.data)&&t.data.length?t.data.map(t=>u(t)).sort():[u(new Date)];a(e),v(e.length-1)}catch(t){const e=u(new Date);a([e]),v(0)}finally{S(!1)}}()},[]);const O=e[d],B=null!==(t=p[O])&&void 0!==t?t:[];function I(){m(t=>{var e;const a=(0,s.A)({},t),n=[...null!==(e=a[O])&&void 0!==e?e:[]];return n.push(o(n.length)),n.forEach((t,e)=>t.row=e+1),a[O]=n,a}),setTimeout(()=>{var t,e;return null===(t=E.current["".concat(B.length,"-guestName")])||void 0===t||null===(e=t.focus)||void 0===e?void 0:e.call(t)},50)}(0,n.useEffect)(()=>{let t=!0;return async function(e){if(e&&(!p[e]||!p[e].length)){D(!0);try{const a=await _(e);if(!t)return;m(t=>(0,s.A)((0,s.A)({},t),{},{[e]:a}))}catch(a){m(t=>(0,s.A)((0,s.A)({},t),{},{[e]:[o(0)]}))}finally{t&&D(!1)}}}(O),()=>{t=!1}},[O]);const{visibleDates:M,visibleStartIndex:F}=(0,n.useMemo)(()=>{const t=e.length;if(t<=2)return{visibleDates:e,visibleStartIndex:0};let a,s;a=0===d?0:d===t-1?t-2:Math.max(0,d-1),s=a+2,s>t&&(s=t,a=s-2);return{visibleDates:e.slice(a,s),visibleStartIndex:a}},[e,d]),z=(0,n.useMemo)(()=>{var t;return(null!==(t=p[O])&&void 0!==t?t:[]).map((t,e)=>{const a=(0,s.A)({},t);return a.tCharge=T.reduce((t,e)=>t+c(a[e]),0),a.balCf=c(a.tCharge)+c(a.balBf)-c(a.bankTr)-c(a.tLedger)-c(a.cash)-c(a.zigSwipe)-c(a.ecoCash)-c(a.usdSwipe),a.row=e+1,a})},[p,O]),V=(0,n.useMemo)(()=>{const t=y[O]||Object.fromEntries(r.map(t=>[t,0])),e=T.reduce((e,a)=>e+c(t[a]),0),a=e+c(t.balBf)-c(t.bankTr)-c(t.tLedger)-c(t.cash)-c(t.zigSwipe)-c(t.ecoCash)-c(t.usdSwipe);return(0,s.A)((0,s.A)({},t),{},{tCharge:e,balCf:a})},[y,O]),H=(0,n.useMemo)(()=>{const t=Object.fromEntries(r.map(t=>[t,0]));return t.balCf=0,z.forEach(e=>{r.forEach(a=>t[a]+=c(e[a])),t.balCf+=c(e.balCf)}),t},[z]),W=(0,n.useMemo)(()=>H.tCharge-H.usdSwipe-H.ecoCash-H.zigSwipe-H.cash-H.tLedger-H.bankTr,[H]);return(0,x.jsxs)("div",{className:"ledger-root",children:[(0,x.jsx)(f,{derivedRows:z,cashAccounts:y,currentDate:O,setCellValue:function(t,e,a){m(n=>{var l;const r=(0,s.A)({},n),i=[...null!==(l=r[O])&&void 0!==l?l:[]];return i[t]=(0,s.A)((0,s.A)({},i[t]),{},{[e]:a}),r[O]=i,r})},setCashValue:function(t,e){A(a=>{const n=(0,s.A)({},a),l=n[O]||Object.fromEntries(r.map(t=>[t,0]));return l[t]=e,n[O]=l,n})},addRow:I,cashTotals:V,totals:H,debtorsInRes:W,inputRefs:E,onSaveRow:async function(t){const e=z[t];if(e&&window.confirm("Save this row?"))try{const a={id:e.id||null,date:O};i.forEach(t=>a[t]=c(e[t])),a.folio=e.folio||"",a.guestName=e.guestName||"",await l.A.post("/ledger/",a),m(e=>{var a;const n=(0,s.A)({},e),l=[...null!==(a=n[O])&&void 0!==a?a:[]];return l[t]=(0,s.A)((0,s.A)({},l[t]),{},{_saveStatus:"saved"}),n[O]=l,n}),await w(l.A,O,V,H,W),alert("\u2705 Row and stats saved!")}catch(a){console.error("Save row error:",a),alert("\u26a0\ufe0f Error saving row or stats. Check console.")}}}),(0,x.jsx)(b,{dates:e,visibleDates:M,visibleStartIndex:F,currentDateIndex:d,prevDate:async function(){if(d>0){const t=d-1,a=e[t],s=t-1>=0?t-1:null,n=null!==s?e[s]:null;await L(n,a),v(t)}},nextDate:async function(){if(d<e.length-1)return void v(d+1);const t=e.length?e[e.length-1]:u(new Date),s=h(t);a(t=>{const e=[...new Set([...t,s])].sort();return v(e.indexOf(s)),e}),await L(t,s)},selectDate:async function(t){if(t<0||t>=e.length)return;const a=e[t];if(!p[a]||!p[a].length){const s=t-1>=0?t-1:null,n=null!==s?e[s]:null;await L(n,a)}v(t)},addNewDateAuto:async function(){const t=e.length?e[e.length-1]:u(new Date),s=h(t);a(t=>{const e=[...new Set([...t,s])].sort();return v(e.indexOf(s)),e}),await L(t,s)},addNewDateAutoBackward:async function(){const t=g(e.length?e[0]:u(new Date)),s=g(t);let n=[...new Set([...e,t])].sort();a(n),await L(s,t),v(n.indexOf(t))},resetViewToLatestDate:async function(){const t=e.length>0?e[e.length-1]:u(new Date);a([t]),v(0),await L(null,t),m(e=>e[t]?{[t]:e[t]}:{}),A(e=>e[t]?{[t]:e[t]}:{})},handleManualDateChange:async function(t){const s=t.target.value;if(!s)return;let n=[...e];e.includes(s)||(n=[...e,s].sort(),a(n));const l=n.indexOf(s),r=l-1>=0?l-1:null,i=null!==r?n[r]:null;await L(i,s),v(l)},addRow:I,saveAll:async function(){R(!0);try{for(const t of z){const e={id:t.id||null,date:O};i.forEach(a=>e[a]=c(t[a])),e.folio=t.folio||"",e.guestName=t.guestName||"",await l.A.post("/ledger/",e)}await w(l.A,O,V,H,W),m(t=>{const e=(0,s.A)({},t);return e[O]=(e[O]||[]).map(t=>(0,s.A)((0,s.A)({},t),{},{_saveStatus:"saved"})),e}),alert("\u2705 All rows and stats saved!")}catch(t){console.error("Save all error:",t),alert("\u26a0\ufe0f Error saving rows or stats. Check console.")}finally{R(!1)}},savingAll:k})]})}}}]);
//# sourceMappingURL=777.581567b3.chunk.js.map