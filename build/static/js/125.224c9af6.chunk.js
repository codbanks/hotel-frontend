"use strict";(self.webpackChunkhotel_frontend=self.webpackChunkhotel_frontend||[]).push([[125],{125:(e,t,a)=>{a.r(t),a.d(t,{default:()=>h});var s=a(555),n=a(43),r=a(931),i=a(216),o=a(579);const l=e=>{if(!e)return"N/A";try{return new Date(e).toISOString().split("T")[0]}catch(t){return e}},c=e=>{let{refreshTrigger:t=0,onEdit:a}=e;const c=(0,i.Zp)(),[d,h]=(0,n.useState)([]),[u,p]=(0,n.useState)(!0),[m,x]=(0,n.useState)(null),v=sessionStorage.getItem("access"),j="".concat(window.location.origin,"/api/v1");return(0,n.useEffect)(()=>{(async()=>{if(p(!0),x(null),v)try{const e=r.A.get("/invoice/invoices/"),t=r.A.get("/staff-invoice/invoices/"),[a,n]=await Promise.all([e,t]),i=(a.data||[]).map(e=>(0,s.A)((0,s.A)({},e),{},{type:"Guest",invoice_number:e.invoice_number,name:e.name||e.company_account_no,roomNo:e.room_no||"N/A",arrival:l(e.arrival_date),departure:l(e.departure_date),created_at:e.created_at||(new Date).toISOString()})),o=(n.data||[]).map(e=>(0,s.A)((0,s.A)({},e),{},{type:"Staff",invoice_number:e.invoice_number,name:e.staff_name||"Staff Account",roomNo:"Staff",arrival:"N/A",departure:"N/A",created_at:e.created_at})),c=[...i,...o].sort((e,t)=>new Date(t.created_at)-new Date(e.created_at));h(c)}catch(t){var e;console.error("Failed to fetch invoices:",(null===(e=t.response)||void 0===e?void 0:e.data)||t.message),x("Failed to load invoice data. Check API status."),h([])}finally{p(!1)}else c("/login")})()},[t]),u?(0,o.jsx)("p",{className:"loading-text",children:"Loading invoices..."}):m?(0,o.jsxs)("p",{className:"error-text",children:["Error: ",m]}):(0,o.jsxs)("div",{className:"invoice-list-container",children:[(0,o.jsx)("div",{className:"list-header",children:(0,o.jsx)("h2",{children:"Recent Invoices"})}),0===d.length?(0,o.jsx)("div",{className:"empty-state",children:(0,o.jsx)("p",{children:"No invoices found."})}):(0,o.jsx)("div",{className:"table-wrapper",children:(0,o.jsxs)("table",{className:"invoice-list-table",children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{style:{width:"8%"},children:"Type"}),(0,o.jsx)("th",{style:{width:"10%"},children:"Invoice No"}),(0,o.jsx)("th",{style:{width:"25%"},children:"Name / Account"}),(0,o.jsx)("th",{style:{width:"8%"},children:"Room No"}),(0,o.jsx)("th",{style:{width:"12%"},children:"Arrival"}),(0,o.jsx)("th",{style:{width:"12%"},children:"Departure"}),(0,o.jsx)("th",{style:{width:"10%"},children:"Receptionist"}),(0,o.jsx)("th",{className:"action-col",style:{width:"15%"},children:"Actions"})]})}),(0,o.jsx)("tbody",{children:d.map(e=>{const t="Staff"===e.type?"staff-invoice":"invoice";return(0,o.jsxs)("tr",{className:"clickable-row ".concat(e.type.toLowerCase(),"-row"),children:[(0,o.jsx)("td",{className:"type-tag type-".concat(e.type.toLowerCase()),children:e.type}),(0,o.jsx)("td",{className:"highlight-text",children:e.invoice_number}),(0,o.jsx)("td",{children:e.name}),(0,o.jsx)("td",{children:(0,o.jsx)("span",{className:"room-badge",children:e.roomNo})}),(0,o.jsx)("td",{children:e.arrival}),(0,o.jsx)("td",{children:e.departure}),(0,o.jsx)("td",{children:e.receptionist}),(0,o.jsxs)("td",{className:"action-col",children:["Guest"===e.type&&(0,o.jsx)("button",{onClick:t=>{t.stopPropagation(),a(e)},style:{marginRight:"8px",background:"transparent",border:"1px solid #ffb547",color:"#ffb547",cursor:"pointer",padding:"4px 8px",borderRadius:"4px",fontSize:"0.8rem"},children:"Edit"}),(0,o.jsx)("a",{href:"".concat(j,"/").concat(t,"/invoices/").concat(e.id,"/pdf/"),onClick:e=>e.stopPropagation(),target:"_blank",rel:"noreferrer",className:"pdf-link",children:"PDF"})]})]},"".concat(e.type,"-").concat(e.id))})})]})})]})},d=e=>{let{onClose:t,onSuccess:a}=e;const[i,l]=(0,n.useState)({staffName:"",staffId:"",department:"",receptionist:"Reception",invoiceNo:""}),[c,d]=(0,n.useState)([{date:(new Date).toISOString().split("T")[0],category:"Food",description:"",amount:0}]),[h,u]=(0,n.useState)(!1),p={Food:"food",Bar:"bar",Laundry:"laundry",Pool:"swimming",Room:"room_hire",Other:"other"},m=e=>{l((0,s.A)((0,s.A)({},i),{},{[e.target.name]:e.target.value}))},x=(e,t,a)=>{const s=[...c];s[e][t]=a,d(s)},v=c.reduce((e,t)=>e+parseFloat(t.amount||0),0);return(0,o.jsx)("div",{className:"fullscreen-modal glass-bg",children:(0,o.jsxs)("div",{className:"staff-modal-content",children:[(0,o.jsxs)("div",{className:"staff-header",children:[(0,o.jsx)("h2",{children:"New Staff Invoice"}),(0,o.jsx)("button",{className:"row-remove",style:{fontSize:"24px"},onClick:t,children:"\xd7"})]}),(0,o.jsx)("div",{className:"staff-input-section",children:(0,o.jsxs)("div",{className:"staff-grid",children:[(0,o.jsxs)("div",{className:"staff-input-group",children:[(0,o.jsx)("label",{children:"Staff Name (Matches Ledger)"}),(0,o.jsx)("input",{name:"staffName",value:i.staffName,onChange:m,placeholder:"e.g. PAUL LUNA"})]}),(0,o.jsxs)("div",{className:"staff-input-group",children:[(0,o.jsx)("label",{children:"Staff ID"}),(0,o.jsx)("input",{name:"staffId",value:i.staffId,onChange:m,placeholder:"ID Number"})]}),(0,o.jsxs)("div",{className:"staff-input-group",children:[(0,o.jsx)("label",{children:"Department"}),(0,o.jsx)("input",{name:"department",value:i.department,onChange:m,placeholder:"e.g. Kitchen"})]}),(0,o.jsxs)("div",{className:"staff-input-group",children:[(0,o.jsx)("label",{children:"Invoice No"}),(0,o.jsx)("input",{name:"invoiceNo",value:i.invoiceNo,onChange:m,placeholder:"INV-001"})]}),(0,o.jsxs)("div",{className:"staff-input-group",children:[(0,o.jsx)("label",{children:"Receptionist"}),(0,o.jsx)("input",{name:"receptionist",value:i.receptionist,onChange:m})]})]})}),(0,o.jsxs)("div",{className:"staff-table-wrapper",children:[(0,o.jsxs)("table",{className:"staff-table",children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{children:"Date"}),(0,o.jsx)("th",{children:"Category"}),(0,o.jsx)("th",{children:"Description"}),(0,o.jsx)("th",{children:"Amount ($)"}),(0,o.jsx)("th",{children:"Action"})]})}),(0,o.jsx)("tbody",{children:c.map((e,t)=>(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{children:(0,o.jsx)("input",{type:"date",value:e.date,onChange:e=>x(t,"date",e.target.value)})}),(0,o.jsx)("td",{children:(0,o.jsx)("select",{value:e.category,onChange:e=>x(t,"category",e.target.value),children:Object.keys(p).map(e=>(0,o.jsx)("option",{value:e,children:e},e))})}),(0,o.jsx)("td",{children:(0,o.jsx)("input",{value:e.description,onChange:e=>x(t,"description",e.target.value)})}),(0,o.jsx)("td",{children:(0,o.jsx)("input",{type:"number",value:e.amount,onChange:e=>x(t,"amount",e.target.value)})}),(0,o.jsx)("td",{children:(0,o.jsx)("button",{className:"row-remove",onClick:()=>{return e=t,void(c.length>1&&d(c.filter((t,a)=>a!==e)));var e},children:"\xd7"})})]},t))})]}),(0,o.jsx)("button",{className:"add-row",onClick:()=>{d([...c,{date:(new Date).toISOString().split("T")[0],category:"Food",description:"",amount:0}])},children:"+ Add Item"})]}),(0,o.jsxs)("div",{className:"staff-actions-footer",children:[(0,o.jsxs)("div",{className:"staff-total",children:["Total: ",(0,o.jsxs)("span",{children:["$",v.toFixed(2)]})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("button",{className:"cancel-btn",onClick:t,children:"Cancel"}),(0,o.jsx)("button",{className:"staff-btn-save",onClick:async()=>{if(i.staffName){u(!0);try{const e=(await r.A.post("/staff-invoice/invoices/",{staff_name:i.staffName,staff_id:i.staffId,department:i.department,receptionist:i.receptionist,invoice_number:i.invoiceNo})).data.id,n={};await Promise.all(c.map(t=>{const a=p[t.category]||"other";return n[a]=(n[a]||0)+parseFloat(t.amount||0),r.A.post("/staff-invoice/lines/",{invoice:e,date:t.date,category:t.category,description:t.description,amount:t.amount})}));const o=(new Date).toISOString().split("T")[0],l=await r.A.get("/ledger/?guestname=".concat(encodeURIComponent(i.staffName),"&date=").concat(o));let d=(0,s.A)({date:o,folio:"STAFF",guest_name:i.staffName},n);if(l.data.length>0){const e=l.data[0];Object.keys(n).forEach(t=>{d[t]=parseFloat(e[t]||0)+n[t]});const t=(0,s.A)((0,s.A)({},e),d);await r.A.put("/ledger/".concat(e.id,"/"),t)}else await r.A.post("/ledger/",d);alert("Staff Invoice processed and Ledger updated!"),a&&a(),t()}catch(e){console.error("Sync Error:",e),alert("Error syncing data. Ensure staff name matches ledger exactly.")}finally{u(!1)}}else alert("Please fill in the Staff Name")},disabled:h,children:h?"Processing...":"Process Staff Invoice"})]})]})]})})},h=()=>{const e=(0,i.Zp)(),t={name:"",address:"",arrivalDate:"",departureDate:"",roomNo:"",roomType:"",adults:1,children:0,rateAllocated:"",companyAccount:"",receptionist:"",vatNumber:"10005237",invoiceNo:""},[a,l]=(0,n.useState)(t),[h,u]=(0,n.useState)([{date:"",description:"",voucher:"",charges:0,credits:0}]),[p,m]=(0,n.useState)(!1),[x,v]=(0,n.useState)(!1),[j,f]=(0,n.useState)(!1),[g,y]=(0,n.useState)(null),[N,b]=(0,n.useState)(0),w=!!sessionStorage.getItem("access");(0,n.useEffect)(()=>{w||e("/login")},[w,e]);const C=()=>{try{const e=sessionStorage.getItem("user_payload");if(e){const t=JSON.parse(e);return t.first_name||t.username||"Reception"}}catch(e){console.error("Error parsing user payload",e)}return"Reception"},S=e=>l((0,s.A)((0,s.A)({},a),{},{[e.target.name]:e.target.value})),A=(e,t,a)=>{if(h[e].id)return;const s=[...h];s[e][t]=a,u(s)},_=h.reduce((e,t)=>e+(parseFloat(t.charges)||0)-(parseFloat(t.credits)||0),0),k=.15*_,I=_+k,D={backgroundColor:"#1a2230",color:"#666",border:"1px solid #333",cursor:"not-allowed"};return(0,o.jsxs)("div",{className:"invoice-page",children:[!p&&!x&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{style:{display:"flex",gap:"15px",marginBottom:"20px"},children:[(0,o.jsx)("button",{className:"new-invoice-btn",onClick:()=>{f(!1),y(null),l((0,s.A)((0,s.A)({},t),{},{receptionist:C()})),u([{date:"",description:"",voucher:"",charges:0,credits:0}]),m(!0)},children:"+ New Guest Invoice"}),(0,o.jsx)("button",{className:"new-invoice-btn",style:{backgroundColor:"#47b5ff",color:"#000",fontWeight:"bold"},onClick:()=>{v(!0)},children:"+ New Staff Invoice"})]}),(0,o.jsx)(c,{refreshTrigger:N,onEdit:async e=>{if("Guest"===e.type){f(!0),y(e.id),l({name:e.name,address:e.address,arrivalDate:e.arrival_date,departureDate:e.departure_date,roomNo:e.room_no,roomType:e.room_type,adults:e.adults,children:e.children,rateAllocated:e.rate_allocated,companyAccount:e.company_account_no,receptionist:C(),vatNumber:e.vat_number,invoiceNo:e.invoice_number});try{const t=await r.A.get("/invoice/invoicelines/?invoice=".concat(e.id));u(t.data)}catch(t){console.error("Failed to fetch lines",t),u([{date:"",description:"",voucher:"",charges:0,credits:0}])}m(!0)}else alert("Cannot edit ".concat(e.type," invoice here. Use the appropriate workflow or log into the admin panel."))}})]}),p&&(0,o.jsxs)("div",{className:"fullscreen-modal glass-bg",children:[(0,o.jsx)("button",{className:"back-floating-center",onClick:()=>m(!1),children:"\u2190 Cancel & Close"}),(0,o.jsx)("div",{className:"modal-fixed",children:(0,o.jsxs)("div",{className:"modal-content-fixed",children:[(0,o.jsxs)("header",{className:"invoice-header",children:[(0,o.jsxs)("div",{className:"header-brand",children:[(0,o.jsx)("h1",{children:"The Pumpkin Hotel (Pvt) Ltd"}),(0,o.jsx)("p",{style:{color:j?"#ffb547":"#888"},children:j?"EDIT MODE (Restricted)":"NEW GUEST INVOICE"})]}),(0,o.jsxs)("div",{className:"invoice-meta",children:[(0,o.jsx)("label",{children:"TAX INVOICE No:"}),(0,o.jsx)("input",{className:"invoiceNo",value:a.invoiceNo,onChange:S,name:"invoiceNo",readOnly:j,style:j?D:{}})]})]}),(0,o.jsxs)("section",{className:"input-grid-section",children:[(0,o.jsx)("h3",{children:"Guest Details"}),(0,o.jsxs)("div",{className:"guest-info",children:[(0,o.jsxs)("div",{className:"input-group full-width",children:[(0,o.jsx)("label",{children:"Name"}),(0,o.jsx)("input",{name:"name",value:a.name,onChange:S,readOnly:j,style:j?D:{}})]}),(0,o.jsxs)("div",{className:"input-group full-width",children:[(0,o.jsx)("label",{children:"Address"}),(0,o.jsx)("input",{name:"address",value:a.address,onChange:S,readOnly:j,style:j?D:{}})]})]})]}),(0,o.jsxs)("section",{className:"input-grid-section",children:[(0,o.jsx)("h3",{children:"Stay Details"}),(0,o.jsxs)("div",{className:"stay-info",children:[(0,o.jsxs)("div",{className:"input-group",children:[(0,o.jsx)("label",{children:"Arrival Date"}),(0,o.jsx)("input",{name:"arrivalDate",type:"date",value:a.arrivalDate,onChange:S,readOnly:j,style:j?D:{}})]}),(0,o.jsxs)("div",{className:"input-group",style:{border:"1px solid #ffb547",borderRadius:"4px"},children:[(0,o.jsx)("label",{style:{color:"#ffb547"},children:"Departure Date"}),(0,o.jsx)("input",{name:"departureDate",type:"date",value:a.departureDate,onChange:S})]}),(0,o.jsxs)("div",{className:"input-group",children:[(0,o.jsx)("label",{children:"Room No"}),(0,o.jsx)("input",{name:"roomNo",value:a.roomNo,onChange:S,readOnly:j,style:j?D:{}})]}),(0,o.jsxs)("div",{className:"input-group",children:[(0,o.jsx)("label",{children:"Room Type"}),(0,o.jsx)("input",{name:"roomType",value:a.roomType,onChange:S,readOnly:j,style:j?D:{}})]}),(0,o.jsxs)("div",{className:"input-group",children:[(0,o.jsx)("label",{children:"Adults"}),(0,o.jsx)("input",{name:"adults",type:"number",value:a.adults,onChange:S,readOnly:j,style:j?D:{}})]}),(0,o.jsxs)("div",{className:"input-group",children:[(0,o.jsx)("label",{children:"Rate Allocated"}),(0,o.jsx)("input",{name:"rateAllocated",value:a.rateAllocated,onChange:S,readOnly:j,style:j?D:{}})]}),(0,o.jsxs)("div",{className:"input-group",children:[(0,o.jsx)("label",{children:"Receptionist"}),(0,o.jsx)("input",{name:"receptionist",value:a.receptionist,readOnly:!0,style:D})]})]})]}),(0,o.jsx)("div",{className:"table-responsive",children:(0,o.jsxs)("table",{className:"invoice-table",children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{style:{width:"15%"},children:"Date"}),(0,o.jsx)("th",{style:{width:"35%"},children:"Description"}),(0,o.jsx)("th",{style:{width:"15%"},children:"Voucher"}),(0,o.jsx)("th",{style:{width:"15%"},children:"Charges ($)"}),(0,o.jsx)("th",{style:{width:"15%"},children:"Credits ($)"}),(0,o.jsx)("th",{style:{width:"5%"}})]})}),(0,o.jsx)("tbody",{children:h.map((e,t)=>{const a=!!e.id,s=a?{backgroundColor:"#1a2230",color:"#666"}:{};return(0,o.jsxs)("tr",{style:s,children:[(0,o.jsx)("td",{children:(0,o.jsx)("input",{type:"date",value:e.date,onChange:e=>A(t,"date",e.target.value),readOnly:a,style:a?{border:"none",background:"transparent",color:"#888"}:{}})}),(0,o.jsx)("td",{children:(0,o.jsx)("input",{type:"text",value:e.description,onChange:e=>A(t,"description",e.target.value),readOnly:a,style:a?{border:"none",background:"transparent",color:"#888"}:{},placeholder:a?"":"Description"})}),(0,o.jsx)("td",{children:(0,o.jsx)("input",{type:"text",value:e.voucher,onChange:e=>A(t,"voucher",e.target.value),readOnly:a,style:a?{border:"none",background:"transparent",color:"#888"}:{}})}),(0,o.jsx)("td",{children:(0,o.jsx)("input",{type:"number",value:e.charges,onChange:e=>A(t,"charges",e.target.value),readOnly:a,style:a?{border:"none",background:"transparent",color:"#888"}:{}})}),(0,o.jsx)("td",{children:(0,o.jsx)("input",{type:"number",value:e.credits,onChange:e=>A(t,"credits",e.target.value),readOnly:a,style:a?{border:"none",background:"transparent",color:"#888"}:{}})}),(0,o.jsxs)("td",{children:[!a&&(0,o.jsx)("button",{className:"row-remove",onClick:()=>{var e;h[e=t].id?alert("You cannot remove past transactions."):u(h.filter((t,a)=>a!==e))},children:"\xd7"}),a&&(0,o.jsx)("span",{style:{fontSize:"12px"},children:"\ud83d\udd12"})]})]},t)})})]})}),(0,o.jsx)("button",{onClick:()=>{const e=(new Date).toISOString().split("T")[0];u([...h,{date:e,description:"",voucher:"",charges:0,credits:0}])},className:"add-row",children:"+ Add Line Item"}),(0,o.jsxs)("div",{className:"footer-layout",children:[(0,o.jsxs)("div",{className:"actions-left",children:[(0,o.jsx)("button",{className:"cancel-btn",onClick:()=>m(!1),children:"Cancel"}),(0,o.jsx)("button",{className:"save-btn",onClick:async()=>{if(window.confirm(j?"Confirm update? Past data is locked.":"Create this invoice?"))try{const e={name:a.name,address:a.address,arrival_date:a.arrivalDate,departure_date:a.departureDate,room_no:a.roomNo,room_type:a.roomType,adults:a.adults,children:a.children,rate_allocated:a.rateAllocated,company_account_no:a.companyAccount,receptionist:a.receptionist,vat_number:a.vatNumber,invoice_number:a.invoiceNo};let t=g;if(j)await r.A.patch("/invoice/invoices/".concat(g,"/"),e);else{const a=await r.A.post("/invoice/invoices/",e);t=a.data.id}await Promise.all(h.map(e=>e.id?Promise.resolve():r.A.post("/invoice/invoicelines/",{invoice:t,date:e.date,description:e.description,voucher:e.voucher,charges:e.charges,credits:e.credits}))),b(e=>e+1),m(!1),alert("Saved Successfully!")}catch(t){var e;console.error("Error:",(null===(e=t.response)||void 0===e?void 0:e.data)||t.message),alert("Error saving invoice.")}},children:j?"Update Invoice":"Save Invoice"})]}),(0,o.jsxs)("div",{className:"totals",children:[(0,o.jsxs)("div",{className:"totals-row",children:[(0,o.jsx)("span",{children:"Sub Total:"})," ",(0,o.jsxs)("span",{children:["$",_.toFixed(2)]})]}),(0,o.jsxs)("div",{className:"totals-row",children:[(0,o.jsx)("span",{children:"VAT (15%):"})," ",(0,o.jsxs)("span",{children:["$",k.toFixed(2)]})]}),(0,o.jsxs)("div",{className:"totals-row grand-total",children:[(0,o.jsx)("span",{children:"Total:"})," ",(0,o.jsxs)("span",{children:["$",I.toFixed(2)]})]})]})]})]})})]}),x&&(0,o.jsx)(d,{onClose:()=>v(!1),onSuccess:()=>{v(!1),b(e=>e+1),alert("Staff Invoice Created Successfully!")}})]})}}}]);
//# sourceMappingURL=125.224c9af6.chunk.js.map